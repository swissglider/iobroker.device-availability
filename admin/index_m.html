<html>
    <head>
        <!-- Load ioBroker scripts and styles-->
        <link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
        <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
        <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css" />

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        />

        <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

        <script type="text/javascript" src="../../js/translate.js"></script>
        <script type="text/javascript" src="../../lib/js/materialize.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>

        <script type="text/javascript" src="../../lib/js/selectID.js"></script>
        <script type="text/javascript" src="../../js/adapter-settings.js"></script>

        <!-- Load our own files -->
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script type="text/javascript" src="words.js"></script>

        <script type="text/javascript">
            // This will be called by the admin adapter when the settings page loads
            function load(settings, onChange) {
                // example: select elements with id=key and class=value and insert value
                if (!settings) return;
                $('.value').each(function () {
                    var $key = $(this);
                    var id = $key.attr('id');
                    if ($key.attr('type') === 'checkbox') {
                        // do not call onChange direct, because onChange could expect some arguments
                        $key.prop('checked', settings[id]).on('change', () => onChange());
                    } else {
                        // do not call onChange direct, because onChange could expect some arguments
                        $key.val(settings[id])
                            .on('change', () => onChange())
                            .on('keyup', () => onChange());
                    }
                });
                onChange(false);

                $('.add-element').click(() => {
                    console.log('test');
                });

                $('.reset_to_default').click(() => {
                    $('#check_interval').val(settings['default_not_overwritte_check_interval']);
                    $('#hours_of_not_available').val(settings['default_not_overwritte_hours_of_not_available']);
                    $('#alarm_to_pushover').prop('checked', settings['default_not_overwritte_alarm_to_pushover']);
                    onChange();
                });

                $('.reset-value').click((event) => {
                    var attri = event.currentTarget.attributes['param2change'].value;
                    var $key = $('#' + attri);
                    if ($key.attr('type') === 'checkbox') {
                        $key.prop('checked', settings['default_not_overwritte_' + attri]);
                    } else {
                        $key.val(settings['default_not_overwritte_' + attri]);
                    }
                    // $('#' + attri).val(settings['default_not_overwritte_' + attri]);
                    onChange();
                });

                $('.dropdown-trigger').dropdown();

                $('.fixed-action-btn').floatingActionButton({
                    direction: 'left',
                    hoverEnabled: false,
                });

                $('.calculateMilliseconds').click(() => {
                    var from = $('#from_time').val();
                    var input_value = $('#calculation_input').val();
                    if (input_value) {
                        if (from === 'seconds') {
                            $('#calculation_result').val(input_value * 1000);
                        } else if (from === 'minutes') {
                            $('#calculation_result').val(input_value * 1000 * 60);
                        } else if (from === 'hours') {
                            $('#calculation_result').val(input_value * 1000 * 60 * 60);
                        } else if (from === 'days') {
                            $('#calculation_result').val(input_value * 1000 * 60 * 60 * 24);
                        }
                    }
                });

                $('.open-dialog-calculate_millisecond').click(() => {
                    var instance = M.Modal.getInstance($('#dialog-calculate_millisecond'));
                    instance.open();
                });

                $('#dialog-calculate_millisecond_set').click(() => {
                    var outVal = $('#calculation_result').val();
                    if (outVal) {
                        $('#check_interval').val(outVal);
                        onChange();
                    }
                });

                $('#addIncludeDevice').click(() => {
                    addSelectDeviceLi(true, false, '...', onChange);
                });

                $('#addExcludeDevice').click(() => {
                    addSelectDeviceLi(false, true, '...E', onChange);
                });

                $('.collection').on('click', '.remove-item', function () {
                    $(this).closest('li').remove();
                    onChange();
                });

                $('.collection').on('click', '.status_editor-item', function () {
                    var $this = $(this);
                    var oldText = $this.closest('li').find('.collectionSpan').text();
                    initSelectId(true, function (sid) {
                        sid.selectId('show', event.target.innerText, function (newId) {
                            if (newId != oldText) {
                                $this.closest('li').find('.collectionSpan').text(newId);
                                onChange();
                            }
                        });
                    });
                });

                // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
                if (M) M.updateTextFields();
            }

            function addSelectDeviceLi(include, exclude, value, onChange) {
                if ((include || exclude) && !(include && exclude)) {
                    collection = 'includeCollection';
                    if (exclude) {
                        collection = 'excludeCollection';
                    }
                    $('.collection.' + collection).append(
                        '<li class="collection-item transparent row">' +
                            '<span class="collectionSpan col s10" contenteditable="true">' +
                            value +
                            '</span>' +
                            '<i class="small material-icons status_editor-item col s1 blue-text text-darken-2">local_library_circle_outline</i>' +
                            '<i class="small material-icons remove-item col s1 red-text text-darken-2">remove_circle_outline</i>' +
                            '</li>',
                    );
                    onChange();
                }
            }

            // This will be called by the admin adapter when the user presses the save button
            function save(callback) {
                // example: select elements with class=value and build settings object
                var obj = {};
                $('.value').each(function () {
                    var $this = $(this);
                    if ($this.attr('type') === 'checkbox') {
                        obj[$this.attr('id')] = $this.prop('checked');
                    } else {
                        obj[$this.attr('id')] = $this.val();
                    }
                });
                callback(obj);
            }

            var selectId;

            function initSelectId(noMultiselect, callback) {
                if (selectId) {
                    return callback(selectId);
                }
                socket.emit('getObjects', function (err, objs) {
                    selectIds = $('#dialog-select-member').selectId('init', {
                        noMultiselect: noMultiselect,
                        objects: objs,
                        imgPath: '../../lib/css/fancytree/',
                        // filter: { type: 'adapter' },
                        //filter: { type: 'enum' },
                        filter: { type: 'state' },
                        name: 'swissglider1adapter',
                        texts: {
                            select: _('Select'),
                            cancel: _('Cancel'),
                            all: _('All'),
                            id: _('ID'),
                            name: _('Name'),
                            role: _('Role'),
                            room: _('Room'),
                            value: _('Value'),
                            selectid: _('Select ID'),
                            from: _('From'),
                            lc: _('Last changed'),
                            ts: _('Time stamp'),
                            wait: _('Processing...'),
                            ack: _('Acknowledged'),
                            selectAll: _('Select all'),
                            unselectAll: _('Deselect all'),
                            invertSelection: _('Invert selection'),
                        },
                        columns: ['image', 'name', 'role', 'room'],
                    });
                    callback(selectIds);
                });
            }

            $(document).ready(function () {
                $('.modal').modal();
                $('.tooltipped').tooltip();
            });
        </script>
    </head>

    <body>
        <div class="m adapter-container">
            <div class="row">
                <div class="col s12 m4 l2">
                    <img src="device-availability.png" class="logo" />
                </div>
            </div>
            <div class="row">
                <div class="col s12 deep-orange lighten-5">
                    <ul class="tabs transparent">
                        <li class="tab col s4">
                            <a class="active" href="#general_tab">
                                <span class="translate">general_tab</span>
                            </a>
                        </li>
                        <li class="tab col s4">
                            <a href="#include_tab">
                                <span class="translate">include_tab</span>
                            </a>
                        </li>
                        <li class="tab col s4">
                            <a href="#exclude_tab">
                                <span class="translate">exclude_tab</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- *********************************************************************** General Tab ****************************************** -->
                <div id="general_tab" class="col s12 blue-grey lighten-5">
                    <div class="section">
                        <div class="row">
                            <div class="col s10 offset-s1">
                                <div class="row">
                                    <div class="col s12">
                                        <div class="row">
                                            <div class="input-field col s11">
                                                <input type="number" class="value" id="check_interval" />
                                                <label for="check_interval" class="translate">check_interval</label>
                                            </div>
                                            <div class="fixed-action-btn col s1">
                                                <a
                                                    class="btn-floating waves-effect waves-light red tooltipped"
                                                    data-position="bottom"
                                                    data-tooltip="Additional Options"
                                                >
                                                    <i class="large material-icons">menu</i>
                                                </a>
                                                <ul>
                                                    <li>
                                                        <a
                                                            class="btn-floating red reset-value tooltipped"
                                                            data-position="bottom"
                                                            data-tooltip="Reset to default"
                                                            param2change="check_interval"
                                                        >
                                                            <i class="material-icons">redo</i>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a
                                                            class="btn-floating green open-dialog-calculate_millisecond tooltipped"
                                                            data-position="bottom"
                                                            data-tooltip="MS calculator"
                                                        >
                                                            <i class="material-icons">input</i>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col s12">
                                        <div class="row">
                                            <div class="col s11 input-field">
                                                <input type="number" class="value" id="hours_of_not_available" />
                                                <label for="hours_of_not_available" class="translate"
                                                    >hours_of_not_available</label
                                                >
                                            </div>
                                            <div class="fixed-action-btn col s1">
                                                <a
                                                    class="btn-floating waves-effect waves-light red tooltipped"
                                                    data-position="bottom"
                                                    data-tooltip="Additional Options"
                                                >
                                                    <i class="large material-icons">menu</i>
                                                </a>
                                                <ul>
                                                    <li>
                                                        <a
                                                            class="btn-floating red reset-value tooltipped"
                                                            data-position="bottom"
                                                            data-tooltip="Reset to default"
                                                            param2change="hours_of_not_available"
                                                        >
                                                            <i class="material-icons">redo</i>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col s12">
                                        <div class="row">
                                            <div class="col s11 input-field">
                                                <input type="checkbox" class="value" id="alarm_to_pushover" />
                                                <label for="alarm_to_pushover" class="translate"
                                                    >alarm_to_pushover</label
                                                >
                                            </div>
                                            <div class="fixed-action-btn col s1">
                                                <a
                                                    class="btn-floating waves-effect waves-light red tooltipped"
                                                    data-position="bottom"
                                                    data-tooltip="Additional Options"
                                                >
                                                    <i class="large material-icons">menu</i>
                                                </a>
                                                <ul>
                                                    <li>
                                                        <a
                                                            class="btn-floating red reset-value tooltipped"
                                                            data-position="bottom"
                                                            data-tooltip="Reset to default"
                                                            param2change="alarm_to_pushover"
                                                        >
                                                            <i class="material-icons">redo</i>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="row">
                                    <a class="waves-effect waves-light btn reset_to_default">
                                        <i class="material-icons left">redo</i>
                                        <span class="translate">reset_to_default</span>
                                    </a>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- *********************************************************************** Include Tab ****************************************** -->
                <div id="include_tab" class="col s12 blue-grey lighten-5">
                    <div class="section">
                        <div class="row">
                            <div class="col s10 offset-s1">
                                <div class="row">
                                    <div class="col s12">
                                        <ul class="collection includeCollection"></ul>
                                        <i class="large material-icons green-text" id="addIncludeDevice"
                                            >add_circle_outline</i
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- *********************************************************************** Exclude Tab ****************************************** -->
                <div id="exclude_tab" class="col s12 blue-grey lighten-5">
                    <div class="section">
                        <div class="row">
                            <div class="col s10 offset-s1">
                                <div class="row">
                                    <div class="col s12">
                                        <ul class="collection excludeCollection"></ul>
                                        <i class="large material-icons green-text" id="addExcludeDevice"
                                            >add_circle_outline</i
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- *********************************************************************** Moduls Tab ****************************************** -->
        <div class="m material-dialogs">
            <div id="dialog-calculate_millisecond" class="modal">
                <div class="modal-content">
                    <div class="row">
                        <div class="input-field col s6">
                            <select id="from_time">
                                <option value="seconds" class="translate">Second</option>
                                <option value="minutes" class="translate">Minute</option>
                                <option value="hours" selected class="translate">Hour</option>
                                <option value="days" class="translate">Days</option>
                            </select>
                            <label class="translate">From</label>
                        </div>
                        <div class="input-field col s6">
                            <select id="to_time">
                                <option value="milliseconds" selected class="translate">Millisecond</option>
                            </select>
                            <label class="translate">To</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s5">
                            <input type="number" id="calculation_input" />
                            <label for="calculation_result" class="translate">ms_calculator_input_value</label>
                        </div>

                        <div class="col s2">
                            <a
                                class="btn-small calculateMilliseconds tooltipped"
                                data-position="bottom"
                                data-tooltip="Calculate the input value into millisecond"
                            >
                                <i class="material-icons">chevron_right</i>
                            </a>
                        </div>
                        <div class="input-field col s5">
                            <input type="number" id="calculation_result" />
                            <label class="translate" for="calculation_result">in Millisecond</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a
                        class="modal-action modal-close waves-effect waves-green btn btn-set"
                        id="dialog-calculate_millisecond_set"
                    >
                        <i class="large material-icons left">check</i>
                        <span class="translate">take the milliseconds</span>
                    </a>
                    <a class="modal-action modal-close waves-effect waves-green btn btn-close">
                        <i class="large material-icons left">close</i>
                        <span class="translate">Cancel</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="m material-dialogs">
            <div id="dialog-select-member" class="modal modal-fixed-footer">
                <div class="modal-content">
                    <div class="row">
                        <div class="col s12 title"></div>
                    </div>
                    <div class="row">
                        <div class="col s12 dialog-content"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="modal-action modal-close waves-effect waves-green btn btn-set"
                        ><i class="large material-icons left">check</i><span class="translate">Select</span></a
                    >
                    <a class="modal-action modal-close waves-effect waves-green btn btn-close"
                        ><i class="large material-icons left">close</i><span class="translate">Cancel</span></a
                    >
                </div>
            </div>
        </div>
    </body>
</html>
